name: Natural Contribution Engine

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  contribute:
    runs-on: ubuntu-latest

    steps:
      - name: Repo'yu √ßek
        uses: actions/checkout@v4

      - name: ≈ûanslƒ± saat mi? (Dice Roll)
        if: github.event_name == 'schedule'
        run: |
          CHANCE=$((RANDOM % 100))
          echo "Zar sonucu: $CHANCE (Gerekli: < 20)"
          if [ $CHANCE -ge 20 ]; then
            echo "üí§ Bu saat pas ge√ßildi. Uyumaya devam."
            exit 0
          fi
          echo "üéâ ≈ûanslƒ± saat! √áalƒ±≈ümaya ba≈ülƒ±yoruz."

      - name: Python k√ºt√ºphanelerini kur
        run: pip install requests

      - name: Repo se√ß
        run: python scripts/pick_repo.py

      - name: Hedef repo clone
        run: |
          REPO=$(cat selected_repo.txt)
          echo "Se√ßilen repo: $REPO"
          git clone https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/$REPO target

      - name: Commit sayƒ±sƒ±nƒ± belirle
        run: |
          COMMITS=$((2 + RANDOM % 11))
          echo "Bu seansta $COMMITS adet commit atƒ±lacak."
          echo "COMMITS=$COMMITS" >> $GITHUB_ENV

      - name: Commit loop
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd target
          
          git config user.name "beserion"
          git config user.email "hyk41hyk@gmail.com"

          for i in $(seq 1 $COMMITS); do
            echo "--- ƒ∞≈üleniyor: $i / $COMMITS ---"
            
            python ../scripts/make_change.py

            python ../scripts/ai_commit_message.py || echo "‚ö†Ô∏è AI hata verdi, devam ediliyor."

            # Commit i≈ülemi
            git add .
            
            if [ -f "../commit_msg.txt" ]; then
              MSG=$(cat ../commit_msg.txt)
            else
              MSG="chore: update"
            fi
            
            git commit -m "$MSG"
            
            sleep $((2 + RANDOM % 9))
          done

          echo "Pushlanƒ±yor..."
          REPO=$(cat ../selected_repo.txt)
          git push https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/$REPO
