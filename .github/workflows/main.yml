name: Natural Contribution Engine

on:
  schedule:
    # Her saat baÅŸÄ± Ã§alÄ±ÅŸÄ±r (00:00, 01:00... 23:00)
    # Merak etme, her saat commit atmayacak! AÅŸaÄŸÄ±daki "Zar Atma" adÄ±mÄ± bunu filtreleyecek.
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  contribute:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Ana Repo'yu Ã§ek (Scriptlere eriÅŸmek iÃ§in)
      - name: Repo'yu Ã§ek
        uses: actions/checkout@v4

      # 2ï¸âƒ£ ZAR ATMA (GÃ¼nde 1-3 kez Ã§alÄ±ÅŸma mantÄ±ÄŸÄ±)
      # Her saat %8 ihtimalle Ã§alÄ±ÅŸÄ±r. (24 saat * 0.08 = ~1.9 run/gÃ¼n)
      # Manuel tetikleme (workflow_dispatch) yapÄ±lÄ±rsa bu kontrolÃ¼ atlar.
      - name: ÅanslÄ± saat mi? (Dice Roll)
        if: github.event_name == 'schedule'
        run: |
          CHANCE=$((RANDOM % 100))
          echo "Zar sonucu: $CHANCE (Gerekli: < 20)"
          if [ $CHANCE -ge 20 ]; then
            echo "ğŸ’¤ Bu saat pas geÃ§ildi. Uyumaya devam."
            exit 0
          fi
          echo "ğŸ‰ ÅanslÄ± saat! Ã‡alÄ±ÅŸmaya baÅŸlÄ±yoruz."

      # 3ï¸âƒ£ Python BaÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± Kur (AI hatasÄ± iÃ§in Ã§Ã¶zÃ¼m)
      - name: Python kÃ¼tÃ¼phanelerini kur
        run: pip install requests

      # 4ï¸âƒ£ Hedef Repo SeÃ§imi
      - name: Repo seÃ§
        run: python scripts/pick_repo.py

      # 5ï¸âƒ£ Hedef Repo Clone (PAT ile)
      - name: Hedef repo clone
        run: |
          REPO=$(cat selected_repo.txt)
          echo "SeÃ§ilen repo: $REPO"
          # Target klasÃ¶rÃ¼ne clone'luyoruz
          git clone https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/$REPO target

      # 6ï¸âƒ£ Commit sayÄ±sÄ±nÄ± belirle (Burst baÅŸÄ±na 2-12 arasÄ±)
      # GÃ¼nde birkaÃ§ kez Ã§alÄ±ÅŸacaÄŸÄ± iÃ§in sayÄ±larÄ± biraz dÃ¼ÅŸÃ¼rdÃ¼k, daha doÄŸal dursun.
      - name: Commit sayÄ±sÄ±nÄ± belirle
        run: |
          COMMITS=$((2 + RANDOM % 11))
          echo "Bu seansta $COMMITS adet commit atÄ±lacak."
          echo "COMMITS=$COMMITS" >> $GITHUB_ENV

      # 7ï¸âƒ£ Commit DÃ¶ngÃ¼sÃ¼
      - name: Commit loop
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd target
          
          # Git kullanÄ±cÄ± ayarlarÄ±
          git config user.name "beserion"
          git config user.email "hyk41hyk@gmail.com"

          for i in $(seq 1 $COMMITS); do
            echo "--- Ä°ÅŸleniyor: $i / $COMMITS ---"
            
            # DeÄŸiÅŸiklik yap (Dosya gÃ¼ncelleme)
            # Script bir Ã¼st dizinde olduÄŸu iÃ§in ../ ile Ã§aÄŸÄ±rÄ±yoruz
            python ../scripts/make_change.py

            # AI MesajÄ± OluÅŸtur (Hata verirse durmaz, devam eder)
            python ../scripts/ai_commit_message.py || echo "âš ï¸ AI hata verdi, devam ediliyor."

            # Commit iÅŸlemi
            git add .
            
            # Commit mesajÄ±nÄ± dosyadan oku, yoksa fallback kullan
            if [ -f "../commit_msg.txt" ]; then
              MSG=$(cat ../commit_msg.txt)
            else
              MSG="chore: update"
            fi
            
            git commit -m "$MSG"
            
            # GitHub'Ä± floodlamamak iÃ§in her commit arasÄ± 2-10 saniye bekle
            sleep $((2 + RANDOM % 9))
          done

          # 8ï¸âƒ£ Push (Hepsi bittikten sonra tek seferde)
          echo "ğŸš€ PushlanÄ±yor..."
          REPO=$(cat ../selected_repo.txt)
          git push https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/$REPO
