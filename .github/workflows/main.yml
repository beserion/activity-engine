name: Natural Contribution Engine

on:
  schedule:
    - cron: "0 6 * * *"  # her g√ºn 06:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  contribute:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Repo √ßek
      - name: Repo'yu √ßek
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ G√ºn√ºn pas ge√ßme kontrol√º (%15)
      - name: Bug√ºn pas mƒ± ge√ßiyoruz? (%15 chance)
        run: |
          if [ $((RANDOM % 100)) -lt 15 ]; then
            echo "Bug√ºn chill üò¥, hi√ß commit yok"
            exit 0
          fi

      # 3Ô∏è‚É£ Repo se√ß
      - name: Repo se√ß
        run: python scripts/pick_repo.py

      # 4Ô∏è‚É£ Repo clone (PAT ile)
      - name: Hedef repo clone
        run: |
          REPO=$(cat selected_repo.txt)
          echo "Se√ßilen repo: $REPO"
          git clone https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/$REPO target

      # 5Ô∏è‚É£ Commit sayƒ±sƒ±nƒ± belirle (5-33 arasƒ±)
      - name: Commit sayƒ±sƒ±nƒ± belirle
        run: |
          COMMITS=$((5 + RANDOM % 29))
          echo "Bug√ºn $COMMITS commit yapƒ±lacak"
          echo "COMMITS=$COMMITS" >> $GITHUB_ENV

      # 6Ô∏è‚É£ Commit loop
      - name: Commit loop
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}  # AI commit i√ßin secret
        run: |
          cd target
          for i in $(seq 1 $COMMITS); do
            # Deƒüi≈üiklik yap
            python ../scripts/make_change.py

            # AI commit mesajƒ± (fallback dahil)
            python ../scripts/ai_commit_message.py || echo "‚ö†Ô∏è AI mesaj hatasƒ±, fallback mesaj kullanƒ±ldƒ±"

            # Commit i≈ülemi
            git config user.name "beserion"
            git config user.email "github@users.noreply.github.com"
            git add .
            git diff --cached --quiet || git commit -m "$(cat ../commit_msg.txt)"
          done

          # Push t√ºm commitler
          REPO=$(cat ../selected_repo.txt)
          git push https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/$REPO
