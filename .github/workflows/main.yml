name: Natural Contribution Engine

on:
  schedule:
    - cron: "0 6 * * *"  # her g√ºn 06:00 ba≈üla
  workflow_dispatch:

permissions:
  contents: write

jobs:
  contribute:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Repo'yu √ßek
      - name: Repo'yu √ßek
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ G√ºn√ºn pas ge√ßme kontrol√º (%15 chance)
      - name: Bug√ºn pas mƒ± ge√ßiyoruz? (%15 chance)
        run: |
          if [ $((RANDOM % 100)) -lt 15 ]; then
            echo "Bug√ºn chill üò¥, hi√ß commit yok"
            exit 0
          fi

      # 3Ô∏è‚É£ Repo se√ß
      - name: Repo se√ß
        run: python scripts/pick_repo.py

      # 4Ô∏è‚É£ Repo clone (PAT ile)
      - name: Hedef repo clone
        run: |
          REPO=$(cat selected_repo.txt)
          echo "Se√ßilen repo: $REPO"
          git clone https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/$REPO target

      # 5Ô∏è‚É£ G√ºn i√ßi seans loop
      - name: G√ºn i√ßi seanslar
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1-3 seans rastgele
          SESSIONS=$((1 + RANDOM % 3))
          echo "Bug√ºn $SESSIONS seans olacak"

          cd target
          for s in $(seq 1 $SESSIONS); do
            # Random bekleme: 0-6 saat (0-21600 sn)
            SLEEP=$((RANDOM % 21600))
            echo "Seans $s i√ßin $SLEEP saniye bekleniyor"
            sleep $SLEEP

            # Random commit sayƒ±sƒ±
            COMMITS=$((5 + RANDOM % 29))
            echo "Seans $s i√ßin $COMMITS commit yapƒ±lacak"

            # Commit loop
            for i in $(seq 1 $COMMITS); do
              python ../scripts/make_change.py

              # AI commit mesajƒ± (fallback)
              python ../scripts/ai_commit_message.py || echo "‚ö†Ô∏è AI mesaj hatasƒ±, fallback mesaj kullanƒ±ldƒ±"

              git config user.name "beserion"
              git config user.email "hyk41hyk@gmail.com"
              git add .
              git diff --cached --quiet || git commit -m "$(cat ../commit_msg.txt)"
            done

            # Push seans sonunda
            REPO=$(cat ../selected_repo.txt)
            git push https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/$REPO
          done
